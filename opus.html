<!DOCTYPE html>
<html>
<script>
    var webasm;
    var audioChunks = [];
    async function init() {
        const { instance } = await WebAssembly.instantiateStreaming(
        fetch("opus.wasm")
        );
        instance.exports.memory.grow(100);
        instance.exports.__wasm_call_ctors();

        webasm = instance;
        console.log(instance);

        let sqrt = instance.exports.sqrt;
        console.log(sqrt(2.0), sqrt(0.25), sqrt(0.01), sqrt(0.00001));
        console.log(Math.sqrt(2.0), Math.sqrt(0.25), Math.sqrt(0.01), Math.sqrt(0.00001));

        let cos = instance.exports.cos;
        console.log(cos(0), cos(1), cos(3.14));
        console.log(Math.cos(0), Math.cos(1), Math.cos(3.14));

        let exp = instance.exports.exp;
        console.log(exp(1), exp(3.5), exp(-6.2));
        console.log(Math.exp(1), Math.exp(3.5), Math.exp(-6.2));

        let opus_packet = [244, 159, 180, 234, 75, 206, 75, 250, 226, 234, 230, 56, 147, 240, 103, 120, 207, 99, 168, 153, 247, 5, 126, 92, 209, 193, 218, 99, 15, 207, 158, 233, 65, 37, 39, 232, 177, 170, 45, 183, 80, 102, 212, 165, 79, 72, 81, 48, 187, 56, 120, 84, 60, 190, 180, 228, 182, 250, 90, 121, 241, 217, 125, 151, 3, 37, 92, 2, 40, 182, 186, 77, 141, 103, 70, 119, 161, 231, 65, 65, 61, 153, 221, 80, 82, 209, 18, 184, 55, 90, 21, 37, 185, 51, 252, 176, 63, 68, 110, 234, 208, 16, 0, 0, 0, 0, 0, 0, 0, 51, 3, 207, 60, 60, 233, 159, 8, 6, 147, 193, 139, 168, 114, 203, 196, 219, 91, 90, 182, 16, 102, 103, 104, 135, 62, 136, 135, 62, 139, 90, 246, 119, 170, 68, 183, 98, 245, 10, 197, 161, 139, 79, 134, 20, 148, 75, 122, 191, 156, 159, 69, 146, 211, 130, 14, 157, 222, 7, 12, 33, 200, 166, 62, 82, 68, 255, 132, 250, 191, 50, 183, 33, 99, 95, 91, 52, 180, 206, 46, 121, 53, 10, 11, 211, 148, 98, 63, 8, 45, 178, 40, 131, 161, 68, 182, 75, 244, 137, 181, 191, 254, 149, 64, 10, 15, 85, 145];

        let ptr = instance.exports.malloc(opus_packet.length);
        const mem = new Uint8Array(instance.exports.memory.buffer, ptr, opus_packet.length);
        mem.set(opus_packet);
        console.log(mem);

        let decoder = instance.exports.create_decoder();
        console.log("decoder", decoder, instance.exports.decoder_error(decoder));

        let out = instance.exports.malloc(960 * 4 * 2); // sizeof(float) == 4
        let output_samples = instance.exports.decode_float(decoder, ptr, opus_packet.length, out, 960 * 2, 0);
        console.log(out, output_samples);
        const samples = new Float32Array(instance.exports.memory.buffer, out, output_samples * 2);
        console.log(samples);

        let expected = [-7.73501e-16, -6.05061e-16, -7.73463e-15, -4.57425e-15, -3.23662e-14, -3.47276e-15, -9.70511e-14, 2.14585e-14, -2.00777e-13, 5.88841e-14, -2.58746e-13, 8.9324e-14, -2.90769e-13, 2.11991e-13, -3.54173e-13, 3.65746e-13, -4.27127e-13, 2.52014e-13, -5.40646e-13, 1.79036e-14, -4.47154e-13, -1.37405e-13, -2.37557e-13, -2.1791e-13, -8.31327e-14, 1.73555e-13, 1.37622e-13, 6.61034e-13, 5.65379e-14, 5.04706e-13, 1.98015e-13, 2.64507e-13, 4.35722e-13, 2.65262e-13, -3.49348e-13, 3.74704e-13, -1.00141e-12, 3.0157e-13, -1.50282e-12, -4.30082e-13, -2.67827e-12, -1.16013e-12, -3.29516e-12, -1.63943e-12, -4.13955e-12, -1.74489e-12, -5.60973e-12, -1.1391e-12, -5.6342e-12, -5.38242e-13, -4.84169e-12, -4.00215e-13, -5.39041e-12, -1.3177e-12, -6.54996e-12, -2.27984e-12, -6.08598e-12, -1.83378e-12, -3.89045e-12, -8.88844e-13, -1.78117e-12, 5.20962e-13, -1.80085e-12, 2.20882e-12, -2.82159e-12, 5.15878e-12, -1.70925e-12, 1.07155e-11, -5.83252e-13, 1.39534e-11, -2.79876e-12, 1.28081e-11, -5.69685e-12, 1.35441e-11, -3.41148e-12, 1.76214e-11, 2.7203e-12, 2.13156e-11, 5.95679e-12, 2.47146e-11, 8.21444e-12, 2.8424e-11, 1.09308e-11, 3.31942e-11, 1.13172e-11, 4.13762e-11, 1.02495e-11, 4.97624e-11, 9.7905e-12, 5.29578e-11, 1.69944e-11, 5.51136e-11, 2.91087e-11, 6.1272e-11, 3.54713e-11, 6.30569e-11, 3.92281e-11, 5.63587e-11, 4.17401e-11, 5.08369e-11, 4.11865e-11, 4.97918e-11, 4.10544e-11, 4.92966e-11, 4.20985e-11, 4.57233e-11, 4.43776e-11, 4.05015e-11, 4.81665e-11, 3.98641e-11, 5.46779e-11, 4.10546e-11, 6.0648e-11, 3.88413e-11, 6.04325e-11, 3.40081e-11, 5.77739e-11, 2.71642e-11, 5.27358e-11, 2.14627e-11, 4.11228e-11, 1.99043e-11, 2.81409e-11, 1.87725e-11, 1.40759e-11, 1.48564e-11, -4.40554e-12, 8.07145e-12, -2.02835e-11, -1.77208e-12, -3.03526e-11, -8.33182e-12, -3.70482e-11, -9.224e-12, -4.1324e-11, -1.30571e-11, -4.37377e-11, -2.10321e-11, -4.5663e-11, -2.76611e-11, -5.18493e-11, -2.80637e-11, -5.87951e-11, -2.83309e-11, -6.81643e-11, -4.26876e-11, -8.39372e-11, -6.18594e-11, -8.74367e-11, -7.13176e-11, -7.64167e-11, -8.13288e-11, -6.62368e-11, -9.88376e-11, -6.06272e-11, -1.12112e-10, -6.03823e-11, -1.15541e-10, -5.87446e-11, -1.15672e-10, -5.89575e-11, -1.14655e-10, -6.47647e-11, -1.13977e-10, -5.89818e-11, -1.13666e-10, -4.05146e-11, -1.04321e-10, -2.73814e-11, -9.15772e-11, -2.6094e-11, -9.35509e-11, -2.45481e-11, -1.01273e-10, -1.6157e-11, -9.80526e-11, -1.26207e-11, -9.01966e-11, -1.70346e-11, -8.19443e-11, -2.01406e-11, -7.26097e-11, -1.4671e-11, -6.22103e-11, -2.50098e-12, -4.70041e-11, 4.81932e-12, -3.46288e-11, 4.40535e-12, -2.97713e-11, 9.24672e-12, -2.80381e-11, 2.22797e-11, -2.62052e-11, 2.89922e-11, -1.96356e-11, 3.30091e-11, -1.13249e-11, 4.06929e-11, -2.45983e-12, 4.10743e-11, 4.7407e-12, 4.26909e-11, 4.21655e-12, 4.51539e-11, 1.74568e-12, 3.4681e-11, 9.24413e-13, 2.71311e-11, 3.36133e-12, 2.41415e-11, 3.8787e-12, 1.62332e-11, -7.27296e-12, 1.09499e-11, -1.47848e-11, 5.27468e-12, -9.70616e-12, 4.06318e-12, -3.07593e-12, 1.08009e-11, 5.50725e-12, 1.56902e-11, 7.72078e-12, 2.04276e-11, -5.73173e-12, 2.36074e-11, -1.68657e-11, 3.09036e-11, -1.91677e-11, 4.79951e-11, -2.37584e-11, 6.19019e-11, -2.76035e-11, 6.79546e-11, -2.37102e-11, 6.94497e-11, -1.34488e-11, 7.05282e-11, -2.43935e-12, 5.22085e-08, 5.21527e-08, 2.85693e-07, 2.85664e-07, 5.64806e-07, 5.64796e-07, 1.35135e-06, 1.35137e-06, 5.68501e-08, 5.68936e-08, -1.33201e-06, -1.33196e-06, -1.02949e-05, -1.02949e-05, -1.6935e-05, -1.69349e-05, -3.05887e-05, -3.05886e-05, -6.19525e-05, -6.19524e-05, -8.3512e-05, -8.35119e-05, -0.000105317, -0.000105317, -0.000136371, -0.000136371, -0.000185046, -0.000185046, -0.000194378, -0.000194378, -0.000230755, -0.000230755, -0.000298639, -0.000298639, -0.000279379, -0.000279379, -0.000324204, -0.000324204, -0.000340402, -0.000340402, -0.000319511, -0.000319511, -0.000347213, -0.000347213, -0.000263539,
        -0.000263539, -0.000207453, -0.000207453, -0.000158247, -0.000158247, -4.95371e-05, -4.9537e-05, 6.79516e-05, 6.79517e-05, 0.00018271, 0.00018271, 0.000335486, 0.000335486, 0.000584525, 0.000584525, 0.000758295, 0.000758295, 0.000984047, 0.000984047, 0.00120228, 0.00120228, 0.00134501, 0.00134501, 0.00157645, 0.00157645, 0.00172481, 0.00172481, 0.00187607, 0.00187607, 0.0020292, 0.0020292, 0.00212288, 0.00212288, 0.00217597, 0.00217597, 0.00224415, 0.00224415, 0.00231551, 0.00231551, 0.00215523, 0.00215523, 0.00193842, 0.00193842, 0.00166945, 0.00166945, 0.0014052, 0.0014052, 0.00110571, 0.00110571, 0.000729503, 0.000729503, 0.000480341, 0.000480341, 4.5033e-05, 4.50331e-05, -0.000260948, -0.000260948, -0.000604232, -0.000604232, -0.00125099, -0.00125099, -0.00156933, -0.00156933, -0.00169606, -0.00169606, -0.00171241, -0.00171241, -0.00171691, -0.0017169, -0.00165763, -0.00165763, -0.00146221, -0.00146221, -0.00131227, -0.00131227, -0.00106514, -0.00106514, -0.000869491, -0.000869491, -0.000541067, -0.000541067, -0.000179385, -0.000179385, 0.000151901, 0.000151901, 0.000563173, 0.000563173, 0.00112141, 0.00112141, 0.00194178, 0.00194178, 0.00218056, 0.00218056, 0.00228904, 0.00228904, 0.00250819, 0.00250819, 0.00236445, 0.00236445, 0.0023824, 0.0023824, 0.00220802, 0.00220802, 0.00194066, 0.00194066, 0.00166326, 0.00166326, 0.00127088, 0.00127089, 0.000776208, 0.000776209, -0.000141279, -0.000141279, -0.000921641, -0.000921641, -0.00156384, -0.00156384, -0.00221719, -0.00221719, -0.00291833, -0.00291833, -0.00350208, -0.00350208, -0.00398161, -0.00398161, -0.00461485, -0.00461485, -0.00485939, -0.00485939, -0.00529279, -0.00529279, -0.00565511, -0.00565511, -0.00574887, -0.00574887, -0.00610838, -0.00610838, -0.0059852, -0.0059852, -0.00570257, -0.00570257, -0.00546138, -0.00546138, -0.0051829, -0.0051829, -0.00459499, -0.00459499, -0.00411986, -0.00411986, -0.00386979, -0.00386979, -0.0028379, -0.0028379, -0.00235081, -0.00235081, -0.00158721, -0.00158721, -0.000614068, -0.000614067, -0.000397909, -0.000397908, 0.000935627, 0.000935627, 0.00171128, 0.00171128, 0.00203631, 0.00203631, 0.00310622, 0.00310622, 0.00374358, 0.00374358, 0.00416608, 0.00416608, 0.00463038, 0.00463038, 0.00550542, 0.00550542, 0.00563568, 0.00563568, 0.00550014, 0.00550014, 0.00571865, 0.00571865, 0.00531852, 0.00531852, 0.00503556, 0.00503556, 0.00431013, 0.00431013, 0.00372013, 0.00372013, 0.00296726, 0.00296726, 0.00191341, 0.00191341, 0.00132835, 0.00132835, -0.000126687, -0.000126686, -0.00126628, -0.00126628, -0.00265893, -0.00265893, -0.004113, -0.004113, -0.00501468, -0.00501467, -0.00657143, -0.00657143, -0.00709482, -0.00709482, -0.00796759, -0.00796759, -0.0093337, -0.0093337, -0.00988069, -0.00988069, -0.0101173, -0.0101173, -0.010415, -0.010415, -0.0112432, -0.0112432, -0.01043, -0.01043, -0.0103475, -0.0103475, -0.0108348, -0.0108348, -0.00916215, -0.00916215, -0.00858805, -0.00858805, -0.00732865, -0.00732865, -0.00570189, -0.00570189, -0.00499883, -0.00499883, -0.00303705, -0.00303705, -0.00180222, -0.00180222, -0.000456648, -0.000456648, 0.00160952, 0.00160952, 0.00338262, 0.00338262, 0.00479492, 0.00479492, 0.00578021, 0.00578021, 0.00736322, 0.00736322, 0.00845263, 0.00845263, 0.00964413, 0.00964413, 0.0109691, 0.0109691, 0.0113205, 0.0113205, 0.0118682, 0.0118682, 0.0118979, 0.0118979, 0.0112667, 0.0112667, 0.0106812, 0.0106812, 0.00996552, 0.00996552, 0.00860966, 0.00860966, 0.00734888, 0.00734888, 0.0064248, 0.0064248, 0.00478259, 0.00478259, 0.00345783, 0.00345783, 0.00157104, 0.00157104, -0.000100515, -0.000100515, -0.00126337, -0.00126337, -0.0032, -0.0032, -0.00395488, -0.00395488, -0.00567357,
        -0.00567357, -0.00711839, -0.00711839, -0.00786451, -0.00786451, -0.00951599, -0.00951599, -0.00937009, -0.00937009, -0.010389, -0.010389, -0.010832, -0.010832, -0.0107522, -0.0107522, -0.0107376, -0.0107376, -0.0087852, -0.0087852, -0.00954428, -0.00954428, -0.00777962, -0.00777962, -0.00631337, -0.00631337, -0.00593824, -0.00593824, -0.00212357, -0.00212357, -0.00151973, -0.00151973, 0.00217832, 0.00217832, 0.00350233, 0.00350233, 0.00526114, 0.00526114, 0.00972516, 0.00972516, 0.00733024, 0.00733024, 0.0150068, 0.0150068, 0.0091296, 0.0091296, 0.0185698, 0.0185698, 0.108512, 0.108512, 0.212376, 0.212376, 0.298453, 0.298453, 0.389294, 0.389294, 0.466871, 0.466871, 0.539256, 0.539256, 0.602472, 0.602472, 0.653655, 0.653655, 0.696142, 0.696142, 0.723172, 0.723172, 0.741764, 0.741764, 0.744906, 0.744906, 0.736061, 0.736061, 0.716164, 0.716164, 0.680848, 0.680848, 0.637702, 0.637702, 0.580749, 0.580749, 0.515505, 0.515505, 0.442224, 0.442224, 0.358291, 0.358291, 0.271519, 0.271519, 0.178005, 0.178005, 0.0822738, 0.0822738, -0.0148968, -0.0148968, -0.113481, -0.113481, -0.207902, -0.207902, -0.300287, -0.300287, -0.387074, -0.387074, -0.466429, -0.466429, -0.538092, -0.538092, -0.601737, -0.601737, -0.654723, -0.654723, -0.695119, -0.695119, -0.725921, -0.725921, -0.7428, -0.7428, -0.747387, -0.747387, -0.740311, -0.740311, -0.719258, -0.719258, -0.687538, -0.687538, -0.643393, -0.643393, -0.588633, -0.588633, -0.523964, -0.523964, -0.450237, -0.450237, -0.369417, -0.369417, -0.281283, -0.281283, -0.189614, -0.189614, -0.0934679, -0.0934679, 0.004063, 0.004063, 0.100308, 0.100308, 0.196099, 0.196099, 0.287272, 0.287272, 0.374074, 0.374074, 0.454625, 0.454625, 0.527281, 0.527281, 0.591172, 0.591172, 0.64436, 0.64436, 0.687458, 0.687458, 0.718116, 0.718116, 0.737042, 0.737042, 0.743163, 0.743163, 0.735718, 0.735718, 0.71693, 0.71693, 0.685125, 0.685125, 0.641516, 0.641516, 0.587394, 0.587394, 0.523454, 0.523454, 0.450116, 0.450116, 0.369061, 0.369061, 0.28247, 0.28247, 0.19002, 0.19002, 0.0950447, 0.0950447, -0.0020114, -0.0020114, -0.099201, -0.099201, -0.193826, -0.193826, -0.286614, -0.286614, -0.373478, -0.373478, -0.454281, -0.454281, -0.527859, -0.527859, -0.591681, -0.591681, -0.646201, -0.646201, -0.688841, -0.688841, -0.719956, -0.719956, -0.738706, -0.738706, -0.744421, -0.744421, -0.738077, -0.738077, -0.718907, -0.718907, -0.687751, -0.687751, -0.64443, -0.64443, -0.59006, -0.59006, -0.525723, -0.525723, -0.452465, -0.452465, -0.37203, -0.37203, -0.285131, -0.285131, -0.193548, -0.193548, -0.0980173, -0.0980173, -0.00090608, -0.00090608, 0.0961894, 0.0961894, 0.192091, 0.192091, 0.284184, 0.284184, 0.371765, 0.371765, 0.452445, 0.452445, 0.525346, 0.525346, 0.58932, 0.58932, 0.642771, 0.642771, 0.685773, 0.685773, 0.71643, 0.71643, 0.734952, 0.734952, 0.740844, 0.740844, 0.733879, 0.733879, 0.714844, 0.714844, 0.683068, 0.683068, 0.640006, 0.640006, 0.585939, 0.585939, 0.521903, 0.521903, 0.449292, 0.449292, 0.368643, 0.368643, 0.281903, 0.281903, 0.189867, 0.189867, 0.0944833, 0.0944833, -0.00257545, -0.00257545, -0.100005, -0.100005, -0.195615, -0.195615, -0.287961, -0.287961, -0.375167, -0.375167,
        -0.456021, -0.456021, -0.529089, -0.529089, -0.593163, -0.593163, -0.647235, -0.647235, -0.690054, -0.690054, -0.721119, -0.721119, -0.739636, -0.739636, -0.745746, -0.745746, -0.739256, -0.739256, -0.720191, -0.720191, -0.689162, -0.689162, -0.646226, -0.646226, -0.592526, -0.592526, -0.528687, -0.528687, -0.455909, -0.455909, -0.375662, -0.375662, -0.288778, -0.288778, -0.197142, -0.197142, -0.102057, -0.102057, -0.00512784, -0.00512784, 0.0918085, 0.0918085, 0.187284, 0.187284, 0.279386, 0.279386, 0.366621, 0.366621, 0.447486, 0.447486, 0.52055, 0.52055, 0.584581, 0.584581, 0.638547, 0.638547, 0.68158, 0.68158, 0.712827, 0.712827, 0.731896, 0.731896, 0.738429, 0.738429, 0.732316, 0.732316, 0.713712, 0.713712, 0.682878, 0.682878, 0.640395, 0.640395, 0.586963, 0.586963, 0.523516, 0.523516, 0.451126, 0.451126, 0.371, 0.371, 0.284514, 0.284514, 0.193106, 0.193106, 0.0983479, 0.0983479];

        let error = 0, diff = 0;
        for (let index = 0; index < expected.length; ++index) {
            diff = expected[index] - samples[index];
            error = diff * diff;
        }
        let rms = Math.sqrt(error / expected.length);
        console.log("Error", rms, Math.log10(rms) * 10, "dB");
    }

    function create_download_file() {
        var a = document.getElementById("a");
        audioBlob = new Blob(audioChunks);
        const audioUrl = URL.createObjectURL(audioBlob);
        a.href = audioUrl
        a.download = "test_opus";
    }
    init();
</script>
<a href="" id="a">click here to download your file</a>
<button onclick="create_download_file()">Create file</button>
</html>
